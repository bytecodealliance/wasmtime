use wasmtime::component::ResourceTable;

use crate::ResourceView;
use crate::cli::{WasiCliCtx, WasiCliView};
use crate::p3::cli::{InputStream, OutputStream};
use crate::p3::ctx::WasiCtx;

/// A trait which provides access to the [`WasiCtx`] inside the embedder's `T`
/// of [`Store<T>`][`Store`].
///
/// This crate's WASI Host implementations depend on the contents of
/// [`WasiCtx`]. The `T` type [`Store<T>`][`Store`] is defined in each
/// embedding of Wasmtime. These implementations are connected to the
/// [`Linker<T>`][`Linker`] by the
/// [`add_to_linker`](crate::p3::add_to_linker) function.
///
/// # Example
///
/// ```
/// use wasmtime_wasi::ResourceView;
/// use wasmtime_wasi::p3::{WasiCtx, WasiCtxBuilder, WasiView};
/// use wasmtime::component::ResourceTable;
///
/// struct MyState {
///     ctx: WasiCtx,
///     table: ResourceTable,
/// }
///
/// impl ResourceView for MyState {
///     fn table(&mut self) -> &mut ResourceTable { &mut self.table }
/// }
///
/// impl WasiView for MyState {
///     fn ctx(&mut self) -> &mut WasiCtx { &mut self.ctx }
/// }
/// ```
/// [`Store`]: wasmtime::Store
/// [`Linker`]: wasmtime::component::Linker
///
pub trait WasiView: ResourceView + Send {
    /// Yields mutable access to the [`WasiCtx`] configuration used for this
    /// context.
    fn ctx(&mut self) -> &mut WasiCtx;

    #[doc(hidden)]
    fn as_wasi_impl(&mut self) -> &mut WasiImpl<Self>
    where
        Self: Sized,
    {
        // TODO: Figure out how to avoid `unsafe`
        // SAFETY: `WasiImpl` is `repr(transparent)`
        unsafe { core::mem::transmute(self) }
    }
}

impl<T: ?Sized + WasiView> WasiView for &mut T {
    fn ctx(&mut self) -> &mut WasiCtx {
        T::ctx(self)
    }
}

impl<T: ?Sized + WasiView> WasiView for Box<T> {
    fn ctx(&mut self) -> &mut WasiCtx {
        T::ctx(self)
    }
}

/// A small newtype wrapper which serves as the basis for implementations of
/// `Host` WASI traits in this crate.
///
/// This type is used as the basis for the implementation of all `Host` traits
/// generated by `bindgen!` for WASI interfaces. This is used automatically with
/// [`add_to_linker`](crate::p3::add_to_linker_sync).
///
/// This type is otherwise provided if you're calling the `add_to_linker`
/// functions generated by `bindgen!` from the [`bindings`
/// module](crate::p3::bindings). In this situation you'll want to create a value of
/// this type in the closures added to a `Linker`.
#[repr(transparent)]
pub struct WasiImpl<T>(pub T);

impl<T: ResourceView> ResourceView for WasiImpl<T> {
    fn table(&mut self) -> &mut ResourceTable {
        T::table(&mut self.0)
    }
}

impl<T: WasiView> WasiView for WasiImpl<T> {
    fn ctx(&mut self) -> &mut WasiCtx {
        T::ctx(&mut self.0)
    }
}

impl<T: WasiView> WasiCliView for WasiImpl<T> {
    type InputStream = Box<dyn InputStream + Send>;
    type OutputStream = Box<dyn OutputStream + Send>;

    fn cli(&mut self) -> &WasiCliCtx<Self::InputStream, Self::OutputStream> {
        &T::ctx(&mut self.0).cli
    }
}
